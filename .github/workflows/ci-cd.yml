name: CI/CD Pipeline

on:
  push:
    branches:
      - assestment3
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: demoassestment
      IMAGE_TAG: latest
      DEPLOYMENT_FILE: assestment-2.yaml
      IMAGE_REPO: sethuk24/demoassestment

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: stuk505@gmail.com
          password: Sethu@245

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

      - name: Setup kubectl
        run: |
          mkdir -p ~/.kube
          echo "YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSQlJFTkRRV1ZwWjBGM1NVSkJaMGxWVm1STFZVOVFPRVV5Vm1WUFptczViakZLWWxad1ltWTVZVGRWZDBSUldVcExiMXBKYUhaalRrRlJSVXdLUWxGQmQwZEVSVmROUWxGSFFURlZSVUY0VFU1aE0xWnBXbGhLZFZwWVVteGplVEZxV1ZSQlpVWjNNSGxOZWtWM1RVUlJlRTFVUlhoTlJFSmhSbmN3ZWdwTmVrVjNUVVJGZUUxVVJYaE5SRUpoVFVKbmVFWnFRVlZDWjA1V1FrRk5WRVJYZERGWmJWWjVZbTFXTUZwWVRYUlpNa1YzWjJkRmFVMUJNRWREVTNGSENsTkpZak5FVVVWQ1FWRlZRVUUwU1VKRWQwRjNaMmRGUzBGdlNVSkJVVU40WjBwUVRrZFpVRUpaVlV4cVNXaHZaVWg1U2s0eE4wbFJOMkp1Um1ZdlUwd0tabU1yY2t0WGNtMDFVVGRaVUVORldWWkllVEpOWkdsdU1HRkpORkJ5YVRkamFYcGxlV05ITVZWR04wTnpVSEJtUzNNMU1FaDBja2RKYmxkUGRGbFFjd3BXTmtSelRqaDBkR0owUkdwaFNXZFpZa05GV25OS1Z6ZENUMkZxUkRST05tdFBlalpRYlRSM2JtdFJkSFpCUW1WRUx6QXdlV0pzTVZablZrMHdjVTVyQ21FeE1teDZVVlI1VnpoblIybGFkMmhMZHpkbGFHVlJSak4xZFU5UVNXNXBkbEphUVU5WVNEZGxkRWcyYmpKb1drMUNXbVJ2VWxSR2NERkJjVEl4WldvS1ozcDBiWEZKUkdKQ1ppOHdURFpGV2xGYVNURjVNMWx5YlZKaFluVmxUMGRPVjJkWlQyTkJUemhDYkhvck1qWmtaVGxaU2poaVVGVkZibEZUYldSWmJRcGxSbmhPVDJaeGNsSkpTRGgyZW5Kc2VIZENUSFZIV0VGSWRqbHNSbTB4VW10V1ZrZ3hkRWxPVm5wb2NtcFZiRzB3WVhvMVFXZE5Ra0ZCUjJwUmFrSkJDazFCTkVkQk1WVmtSSGRGUWk5M1VVVkJkMGxDUW1wQlVFSm5UbFpJVWsxQ1FXWTRSVUpVUVVSQlVVZ3ZUVUl3UjBFeFZXUkVaMUZYUWtKUlZHSmhiMjRLVlc5U2MzRkxVQzl3TWxreFZWQmhaelJDTDFBeWVrRk9RbWRyY1docmFVYzVkekJDUVZGelJrRkJUME5CVVVWQloySllkMmc1TnpKYVNISktUVEJXUkFwVWMxWmxVVkJMYWxKUlYyWTBkMXBOUkhSMGRVa3dVV1pxY1RWVmRVWndWemRRVDNWaFZTOTNjVmw2U1VVd1EycFlZMnhST0U0elIwdFRWMUJRV2xCQ0NuSk1VSGRVZEhkTksyZENjQ3RsWjBaU1VGWnhMMjlKTTFKMWRUbFhVbVZyWjA5d1MydG9SRUptVkN0bWNtWjVXSGxSVkUwclVUQktNVFpaWjJSek9GQUtka3hUUm5OU09EWjJNVW96ZUdSb09FVkJZMnRHVGpoUWJVOWxlVmxOV21wb1EzRlhZMVJUUzFOTGVuRXhjMXBZUm1Ob2NESnlkVzFyU1c5YVpVYzBad3A2WWxRMU0wSlRTU3R2YzFNdlZFSlpNRmd3UTJSV1VEUjFjbTEzZVVoSFJXVkJSelJ5UWs5U1QzVkhXa0ZtWlZCUGVVMVlORlpzYWpWNWRsTjVSbEJaQ25wbVRGUkdiQ3RyY2pVck1VTlpVazAwZFVwcGEzcGtaVUZtVVVsNWVHeEVSRE5wUnpGT1ZFOVdhR1pKYWxCTFpGcE9VSFY2VjFvM1RqRlVjVWh3TXpRS1UweGljMkZCUFQwS0xTMHRMUzFGVGtRZ1EwVlNWRWxHU1VOQlZFVXRMUzB0TFFvPQogICAgc2VydmVyOiBodHRwczovL2syOC5pbmRpYW5pYy5jb206NjQ0MwogIG5hbWU6IGt1YmVybmV0ZXMKLSBjbHVzdGVyOgogICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5OiAvaG9tZS9pbmRpYW5pYy8ubWluaWt1YmUvY2EuY3J0CiAgICBleHRlbnNpb25zOgogICAgLSBleHRlbnNpb246CiAgICAgICAgbGFzdC11cGRhdGU6IFdlZCwgMDUgTm92IDIwMjUgMTA6MDk6MjAgSVNUCiAgICAgICAgcHJvdmlkZXI6IG1pbmlrdWJlLnNpZ3MuazhzLmlvCiAgICAgICAgdmVyc2lvbjogdjEuMzYuMAogICAgICBuYW1lOiBjbHVzdGVyX2luZm8KICAgIHNlcnZlcjogaHR0cHM6Ly8xOTIuMTY4LjQ5LjI6ODQ0MwogIG5hbWU6IG1pbmlrdWJlCmNvbnRleHRzOgotIGNvbnRleHQ6CiAgICBjbHVzdGVyOiBtaW5pa3ViZQogICAgZXh0ZW5zaW9uczoKICAgIC0gZXh0ZW5zaW9uOgogICAgICAgIGxhc3QtdXBkYXRlOiBXZWQsIDA1IE5vdiAyMDI1IDEwOjA5OjIwIElTVAogICAgICAgIHByb3ZpZGVyOiBtaW5pa3ViZS5zaWdzLms4cy5pbwogICAgICAgIHZlcnNpb246IHYxLjM2LjAKICAgICAgbmFtZTogY29udGV4dF9pbmZvCiAgICBuYW1lc3BhY2U6IGRlZmF1bHQKICAgIHVzZXI6IG1pbmlrdWJlCiAgbmFtZTogbWluaWt1YmUKY3VycmVudC1jb250ZXh0OiBtaW5pa3ViZQpraW5kOiBDb25maWcKcHJlZmVyZW5jZXM6IHt9CnVzZXJzOgotIG5hbWU6IGFkbWluCiAgdXNlcjoKICAgIGNsaWVudC1jZXJ0aWZpY2F0ZS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSWFZFTkRRV3RIWjBGM1NVSkJaMGxWVldGb2IzSlJabVUwV2xoVFMyVkNTRkpYVVVFelRuZ3hUbFk0ZDBSUldVcExiMXBKYUhaalRrRlJSVXdLUWxGQmQwZEVSVmROUWxGSFFURlZSVUY0VFU1aE0xWnBXbGhLZFZwWVVteGplVEZxV1ZSQlpVWjNNSGxPUkVFMFRXcEJkMDVVUlRKTlJFSmhSbmN3ZVFwT1ZFRTBUV3BCZDA1VVJUSk5SRUpoVFVSUmVFWjZRVlpDWjA1V1FrRnZWRVJ1VGpWak0xSnNZbFJ3ZEZsWVRqQmFXRXA2VFZKcmQwWjNXVVJXVVZGRUNrVjRRbkprVjBwc1kyMDFiR1JIVm5wTVYwWnJZbGRzZFUxSlNVSkpha0ZPUW1kcmNXaHJhVWM1ZHpCQ1FWRkZSa0ZCVDBOQlVUaEJUVWxKUWtOblMwTUtRVkZGUVhkQ1NXTjBZWFZqUkZwM05HMWFSREJJUmpsTWRHSlJia1ZtTjIxdWR6aFlXVnB1T0c1RUsxaEZjRkpGVTNoTlEwUlNhMHBvU1d4TVFWQXpZZ3BvVVRjNE5qVmtSREJFV0RaS2VIZGhNbWhHV0VvNFJraDBia1YzTHpOVU9XazRaRWg0TWxwbWJraDFSelZ0UnpsVVVsVjRlbTR4WlU5c2RXUXJhMWMzQ25SRlJWcG9iRFJPWW5GTGFqazRhMHhUVDBGVFEySTNkWGM1V1hKek16aFRjalJLVm1SUFluQmFZMUkxTUhsaVpqZGhZa1JLZFhGelYySk1MM05YTjNNS1ZGaDBabVV4TTNsRksyVjNlVkpSWjB4aGJqaFFTRlZqY3pVeVUyNWhRM05KYkVaVE9WZEJVMWhMWmxRNWRHTlhLekIwUlVRNU5WazFheTk0YW1kclN3bzVXWEZ1VUZKWlZEbFFaM0ZWVml0VU1uQkRWVVo1YURkUk5IRnBhell5YkZCVlYzQnRZM0o0VWlzdmEyRnRRV3gyUWpoM2R6Um5VMVF5UWpCSFdXSjFDbWhpVTNSMGJpOTJXRkJwVm1Ga2RrMVZUMUkxVlVGb2JVTjNTVVJCVVVGQ2J6TTRkMlpVUVU5Q1owNVdTRkU0UWtGbU9FVkNRVTFEUW1GQmQwaFJXVVFLVmxJd2JFSkNXWGRHUVZsSlMzZFpRa0pSVlVoQmQwVkhRME56UjBGUlZVWkNkMDFEVFVGM1IwRXhWV1JGZDBWQ0wzZFJRMDFCUVhkSVVWbEVWbEl3VHdwQ1FsbEZSa0ZaU2pBMmFraHBhWEI2VTA1SE5XbGlhblptVkVoVEwwcDRlazFDT0VkQk1WVmtTWGRSV1UxQ1lVRkdRazUwY1dsa1UyaEhlVzl2THl0dUNsbHFWbEU1Y1VSblNEZ3ZZazFCTUVkRFUzRkhVMGxpTTBSUlJVSkRkMVZCUVRSSlFrRlJRbUZ4ZGpOcFpFaHhhSGx1VFVORk1VdE1VeklyVERrNE9GSUtlVnBzU0d4d2RrRmtabk13UWxWU05rNXRNa1ZpUm1aMU5XbGhTeTlHVFdsb0sydEljbGRxZG5SeU1qUnRLM0JSY2k4Mk1Xd3lXbmx0VGxSMmNIa3hOUXBEUVVOdFlVcDRjRnBxZURrMmNtMXJkMFpZZEcwM2VuTlNNWFZZY2tSWE15dFpiM1p1ZG5GTlJXaEVSSGx5Um10SFlVaG1OMjU0WWtwcVNsWXpNbmxVQ25GTkwwcG1SRmxvV0c1b0sxVmtkR3hOWTBwWWVXcE9hVTFTT1VRMGREUlpkeXM1VEZKWFVXSk5OM2xwTURSc1ZqaDFjRm96YTJKTkwyb3pOalE0YkZZS04xbEdVbUowVTJNMllXWjJZMDk1WWxGTU5YWXlkRFpMZFZnd01qTndTWFJoUmpWMlRHZzBlbEJOWW5sUmIyVjZNekZSWVd4amMxRTVXSFpLWkd4cGR3cDVhbUZwTUhkcWQzQTFOMDVTZVRST2VrbEJOek01Um01RlQxTmxZbVpyUkU5UWQySlBNMFZNVmtaaVVGVjBlbFo2UzJ0bU5tdFFRMk13VW13S0xTMHRMUzFGVGtRZ1EwVlNWRWxHU1VOQlZFVXRMUzB0TFFvPQogICAgY2xpZW50LWtleS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJTVTBFZ1VGSkpWa0ZVUlNCTFJWa3RMUzB0TFFwTlNVbEZjRUZKUWtGQlMwTkJVVVZCZDBKSlkzUmhkV05FV25jMGJWcEVNRWhHT1V4MFlsRnVSV1kzYlc1M09GaFpXbTQ0YmtRcldFVndVa1ZUZUUxRENrUlNhMHBvU1d4TVFWQXpZbWhSTnpnMk5XUkVNRVJZTmtwNGQyRXlhRVpZU2poR1NIUnVSWGN2TTFRNWFUaGtTSGd5V21adVNIVkhOVzFIT1ZSU1ZYZ0tlbTR4WlU5c2RXUXJhMWMzZEVWRldtaHNORTVpY1V0cU9UaHJURk5QUVZORFlqZDFkemxaY25Nek9GTnlORXBXWkU5aWNGcGpValV3ZVdKbU4yRmlSQXBLZFhGelYySk1MM05YTjNOVVdIUm1aVEV6ZVVVclpYZDVVbEZuVEdGdU9GQklWV056TlRKVGJtRkRjMGxzUmxNNVYwRlRXRXRtVkRsMFkxY3JNSFJGQ2tRNU5WazFheTk0YW1kclN6bFpjVzVRVWxsVU9WQm5jVlZXSzFReWNFTlZSbmxvTjFFMGNXbHJOakpzVUZWWGNHMWpjbmhTS3k5cllXMUJiSFpDT0hjS2R6Um5VMVF5UWpCSFdXSjFhR0pUZEhSdUwzWllVR2xXWVdSMlRWVlBValZWUVdodFEzZEpSRUZSUVVKQmIwbENRVUpqUW14SFRFZFlXR3BpTXpSUE1RcGplV1kyTW1sNU0yMVlOVEJWT1dReGFsVXhjR3B1UzBGM01qSTRVMHh1WkZkMkswdHZhazB6TlhJMFJuRnJaWG94WlU4MlUwdHpiRGRCVEVoUlVXZG9Dbm8xYVRWa1FXVk5XVEYzVmk5V1JFTXlMM2R6WWxGT2JsbEhPREJCWlVzM2VWTXhPRzl6TjBkeWNFOU9lWEl2Tm14RU5HVkJaVzVuYmxaa1QzYzBWa1lLU1dGUU9VNU5hRTFZVVhWNFEzVklkVGhMUjBORWVUZGlZU3RSTkhKTVlXbHlRVWR2UjFJck5qRnNialZtV0d4QlZYQTVka05pU1U5VFVGQm5XVTlhYndwSU9WUjJNVzVhYjFGSWNHVTBZalZtVkdzcmR6bGpjQzlNVldSallVcHpObUp6V1RSWWVERklPVTFVUW5CRlJqaE5jMDFKTUd4YVNYcE9ibEJQYUVaMkNuRk9TazlSZEZSSVdYTXlWbG93SzJ4U1NqaE9UVTFYYVRWRk9GZGxUR1JHUlV4eFkyMDBUbU5XY0hsMk1GWkZaVmd2TW1SeGEyaFBSRUowZGpaT05rZ0tZWFEyVlU1T1JVTm5XVVZCTTB3M1VUWm5Ra2R6TmpoMVowdGxVVWhoVWtNd2MySXdhbGxNWVdWM1FuWTNOVWxvZDFaTWRGVkVRM1JqTlhGdGJsQkRPUXBSUlU1RGNFRjFZMmsxWWtoWVpIcDVPRlExYTNOaGJYRmlUakZMZUhWblZVSnZjRzVvTDFwV2NHNDBZV0pZVVZaVGFIRndiM050U1d0VWJuWlBZMGxXQ2sxUVVrbHlVWGREY1ZKRE1XOVVTMjl1Uld3M2JXMUpUamRrZFRSclkxRTVWbXN2VG10QlZHazBkblJZUlZOT00wVnFiM0JHY0dORFoxbEZRVE55TjNVS2VuTlZVVkl2ZFZoU2VESXdRMll4WkdWRmVFUkJWVXcySzNWSVZ6RTNLMUpMUjNSdFlrdEJla3BFVjB4dmFHMWlaa2hTZDBaa1QyNWlkMnAyUkVOcEx3cE1hRTlUTm04M2MxTktha3hDUkhCVFlUaE5VUzlTTjFKWU5IRmlPWHBxTTBGcE1WQTJZM0V2VDJ4bllsSkxUM05vUkRkeVYwc3ZibUpqVTNJMVRrSXZDbWN2ZUdsM1VuVjZXVm8wZUVNeVVtNU5abUZ1Y21RclltUkxObmxuWmxwMldWRlZWRXh4TUVObldVRjBhMDVZWlRrMUsyZG9OVU0xZW1SNlduZFpXbkFLY1RsbVpsQm9kVXhQUmxCcGVDczVaakJLV21JM2VrSmxjRXBYZGpNMlIzaEhha1YyVnpWWk9ESnBjbVJJVkdGdmVGcENWR1pCY0VvemIxRkpLM1UzYmdwVGNuRkZVR3A2THpKU1puSmpRVXhXUVZKMmVrWnNZWGxaTlhOV0sxSkpWM2RPV1dadmJFMUxVWGRETmk5YVNVRmpUWEZ4TWpSTE1HcHdOVk4xU1dSUkNuZGlhRlVyYVRBM1dGWmFhbTB3WVVFMVRFTkhhMUZMUW1kUlEwOHdabEJFUW13emFrZGlSWE4xZVVodFUyUnpNWFZCWnpaa1pEQkNTV1U0YTFaTlRsb0tTRVYzU0VkRmVsTlRZbUp1VkNzekwxSmFWbU50VjBwQk9HOVNOekJ0UTB0NFlXZHpNVEJyZGxoNlJFVXpSRkpsZG1sMFZtTlFOR3RsV0ZvMVpFMUJSUXBYUms1c0x6QmlVSFpTUWpJeVZUbFVWMEpwUlhVdmVubDRLMnBFYUU5Q1QwY3pVMmxvZDFaclkxRTNXRlpEUWt0NUwwWkdjbWh6TmtoSk1TdG5VMnd6Q2taek4zVXpVVXRDWjFGRE4wRnlhazFwVVhsUFQzTjZNMWxsYkhObVJuRkpXVE5qUldocmJWZzFUVTAwUVUxa2R6SnNSa0ZzWVd0d2VIUnhlRlJFTjJjS2NsSjRjbHBxVTJjNGNERXZiVEJYSzBoc2FtRnNVRWhVY1VsTGJrc3ljVWRZVVhaSlFtSTFOekl6UWtSd1VHOXdaalZrVHpSalpUQkNXVXN3Y0dRM1N3b3ZURTFrZVRaRWNFNTVhVU40VFV4TWNTOWlSbkZ3VVZFM1dFUnNWSEpuVUZWTE9HUkVVME53UjFJcmJrRkNaWFIwVDBOVk1VRTlQUW90TFMwdExVVk9SQ0JTVTBFZ1VGSkpWa0ZVUlNCTFJWa3RMUzB0TFFvPQotIG5hbWU6IG1pbmlrdWJlCiAgdXNlcjoKICAgIGNsaWVudC1jZXJ0aWZpY2F0ZTogL2hvbWUvaW5kaWFuaWMvLm1pbmlrdWJlL3Byb2ZpbGVzL21pbmlrdWJlL2NsaWVudC5jcnQKICAgIGNsaWVudC1rZXk6IC9ob21lL2luZGlhbmljLy5taW5pa3ViZS9wcm9maWxlcy9taW5pa3ViZS9jbGllbnQua2V5Cg==" | base64 -d > ~/.kube/config

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f ${{ env.DEPLOYMENT_FILE }}
          kubectl rollout status deployment/demo-app
          kubectl get svc
